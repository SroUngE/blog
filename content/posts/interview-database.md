---
title: "Interview Database"
date: 2024-02-01
draft: true
description: "基于 ChatGPT3.5，回答常见的数据库面试题。"
tags: ["Database"]
featuredImage: "https://s2.loli.net/2024/01/23/FdJWU6IpNZGfACv.png"
featuredImagePreview: "https://s2.loli.net/2024/01/23/FdJWU6IpNZGfACv.png"
---



### 事务

数据事务是一组数据库操作，要么全部执行成功，要么全部失败。目的是确保数据库的一致性，通过将操作集合成一个单一工作单元。

### 事务 ACID 特性

1. **原子性（Atomicity）**：确保事务中的所有操作要么全部执行成功，要么全部失败。如果有任何操作失败，整个事务会被回滚到初始状态，保持数据的一致性。

2. **一致性（Consistency）**：事务执行后，数据库从一个一致性状态转移到另一个一致性状态。这意味着事务执行后，数据库的完整性约束仍然得到保持，不会破坏数据库的一致性。比如，假设数据库中有一个规定所有用户必须有唯一用户名的约束。如果一个事务试图插入一个已经存在的用户名，这就违反了唯一性规则，可能导致数据库状态不一致。

3. **隔离性（Isolation）**：多个事务可以并发执行，但它们的执行应该彼此独立，一个事务的执行不应影响其他事务。隔离性确保在并发环境中每个事务都感觉到它是唯一执行的。

4. **持久性（Durability）**：一旦事务成功提交，其结果应该是永久性的，即使系统崩溃或重启，已提交的事务对数据库的改变应该得以保留。

### 事务的生命周期

事务的生命周期通常包括以下阶段：

1. **开始（Start）：** 事务的生命周期始于开始操作。在这个阶段，事务被标记为已启动，可以执行一系列数据库操作。

2. **执行（Execute）：** 在执行阶段，实际的数据库操作发生。这包括读取、插入、更新或删除数据库中的数据。这一阶段可以包含多个操作。

3. **提交前（Pre-commit）：** 在提交前阶段，事务已经执行完所有的数据库操作，但尚未将更改永久保存到数据库。在这个阶段，系统会进行一些检查，确保事务的操作是有效和合法的。

4. **提交（Commit）：** 提交阶段是事务的关键部分。在这一步，事务的所有更改被写入数据库，从而确保它们是永久性的。如果一切正常，事务成功提交；否则，如果发生错误，可能会回滚事务。

5. **回滚（Rollback）：** 如果在事务执行的任何阶段发生错误或违反了一致性，事务会被回滚。回滚意味着撤销所有已执行的更改，将数据库恢复到事务开始前的状态。

6. **完成（End）：** 事务的生命周期在提交或回滚后结束。如果事务成功提交，数据库保留更改；如果事务回滚，数据库恢复到开始前的状态。

### 脏读、不可重复读、幻读

这是三种并发事务可能引发的问题：

1. **脏读（Dirty Read）：** 当一个事务读取了另一个事务未提交的数据时，就发生了脏读。如果另一个事务在后续操作中回滚，读取到的数据实际上是无效的。例如，A读取了B正在修改的订单金额，但B后来回滚了修改，导致A读取的数据是不正确的。

2. **不可重复读（Non-repeatable Read）：** 不可重复读指的是在一个事务内，两次查询**同一行数据**，返回了不同的结果。这可能是因为另一个并发事务在两次查询之间修改了数据。例如，A首先查询某用户的余额，然后B在中间修改了该用户的余额，最后A再次查询余额时，结果不同。

3. **幻读（Phantom Read）：** 幻读发生在一个事务内，在两次查询之间**插入或删除了数据**，导致第二次查询返回了新增或减少的数据行。例如，A首先查询了某时间范围内的订单数量，然后B在中间插入了一些新订单，最后A再次查询订单数量时，结果发生变化。

### 事务的隔离级别

事务的隔离级别指的是多个事务并发执行时，各事务之间的隔离程度。有四个标准的隔离级别，由低到高分别是：

1. **读未提交（Read Uncommitted）**：允许一个事务读取另一个事务未提交的数据，最低的隔离级别，可能导致脏读（读取了未提交的数据）。

2. **读已提交（Read Committed）**：一个事务只能读取已提交的其他事务的数据，避免了脏读，但可能存在不可重复读和幻读的问题。

3. **可重复读（Repeatable Read）**：确保在同一个事务中多次读取同样的数据时，结果始终一致。避免了脏读和不可重复读，但可能存在幻读（插入新数据）。

4. **串行化（Serializable）**：最高的隔离级别，确保事务之间彼此完全隔离，防止脏读、不可重复读和幻读，但性能开销也最大。

### 数据库引擎

数据库存储引擎是数据库管理系统（DBMS）中负责管理数据存储和检索的组件。它负责实现数据的物理存储、索引、事务处理和查询操作等功能。不同的数据库系统支持不同的存储引擎，每个存储引擎都有其独特的特性和适用场景。

一些常见的数据库存储引擎包括：

1. **InnoDB：** 一种事务型存储引擎，用于MySQL数据库系统。它支持事务处理、外键约束和并发控制，并提供高可靠性和性能。
2. **MyISAM：** 也是MySQL的一种存储引擎，适用于读密集型应用。它不支持事务处理，但在读取频繁、写入较少的情况下性能较好。
3. **MongoDB WiredTiger：** 用于MongoDB的存储引擎，支持事务、压缩和并发控制，适用于处理大量数据和高并发的场景。
4. **Oracle数据库存储引擎：** Oracle支持多种存储引擎，其中包括行存储引擎和列存储引擎等，以满足不同的业务需求。

### 关系数据三大范式

数据库三大范式是关系数据库设计中的规范，用于确保数据的结构良好、规范化、减少冗余。这三大范式分别是：

1. **第一范式（1NF）：** 要求数据库表的每一列都是不可分割的原子数据项，即每个字段只包含单一值。这有助于消除重复的数据，并确保数据的唯一性。

2. **第二范式（2NF）：** 在满足第一范式的基础上，每个非主键列完全依赖于整个主键，而不是依赖于主键的一部分。这有助于消除部分依赖，进一步减少冗余。

3. **第三范式（3NF）：** 在满足第二范式的基础上，任何非主键列都不依赖于其他非主键列。这有助于消除传递依赖，确保数据表的独立性。

### 索引

数据库索引是一种数据结构，用于提高数据库的查询性能。它类似于书籍的目录，通过创建索引，数据库系统能够更快速地定位和访问特定值，而不必扫描整个数据表。索引可以加速数据检索的速度，但同时也会增加写入操作的成本。

### 索引的优缺点

优点：

1. **加速查询操作：** 索引使数据库系统能够更迅速地定位符合查询条件的数据，从而提高查询的效率。

2. **唯一性约束：** 唯一索引确保某个列的值在整个表中是唯一的，用于维护数据的一致性和完整性。

3. **加速排序和分组操作：** 当进行排序或分组操作时，索引可以提供有序的数据，减少排序和分组的开销。

4. **加速连接操作：** 在多表关联查询时，通过索引可以更快速地定位相关联的数据。

缺点：

1. **增加写操作成本：** 对表进行插入、更新和删除等写操作时，索引的维护会增加额外的开销。每次写操作都可能需要更新索引结构，导致写入性能下降。

2. **占用存储空间：** 索引占用额外的存储空间。对于大型表和多个索引的情况，这可能会显著增加存储需求。

### 索引的类型

1. **聚簇索引（Clustered Index）：** 数据表的行存储顺序与索引的顺序一致。一张表只能有一个聚簇索引。也就是我们常说的主键索引。

2. **非聚簇索引（Non-clustered Index）：** 数据表的行存储顺序与索引的顺序无关。一张表可以有多个非聚簇索引。

3. **唯一索引（Unique Index）：** 确保索引列的值在表中是唯一的，可用于实现主键或唯一性约束。主键索引是一种特殊的唯一索引，不允许有空值。

4. **复合索引（Composite Index）：** 包含多个列的索引，用于加速涉及多个列的查询。

### 索引设计原则

最佳实践在索引设计中可以总结为以下几点：

1. **主键自动创建唯一索引：** 主键列自动创建唯一索引，确保主键的唯一性。
2. **根据查询频率创建索引：** 针对频繁执行的查询，特别是在WHERE条件中的列，考虑创建索引以提高查询性能。
3. **使用复合索引：** 对于经常一起使用的列，创建复合索引，以减少索引数量，提高查询效率。
4. **定期维护索引：** 定期检查和优化索引，删除不再需要的索引，确保索引的有效性。
5. **避免创建过多索引：** 不要为每个列都创建索引，选择关键的查询列进行索引，避免过多的索引导致维护成本上升。
6. **使用覆盖索引：** 考虑创建覆盖索引，以避免查询时额外访问数据表，从而提高性能。
7. **注意排序、分组和联合：** 索引可以加速排序、分组和联合操作，因此在需要进行这些操作的列上创建索引可能有助于提高性能。
8. **注意对于小表的索引：** 对于小表，全表扫描的性能可能更好，不一定需要创建索引。

### 索引的数据结构

常见的索引数据结构包括B树、B+树、哈希索引等。 B树适用于磁盘存储，而B+树在其基础上优化，常用于数据库索引。哈希索引通过哈希函数加速查找，适用于等值查询。

1. **B树：**
   - 平衡树结构，每个节点可有多个子节点。
   - 数据和索引存储在所有节点。
   - 适用于磁盘存储，支持范围查询。
2. **B+树：**
   - 基于B树，但只在叶子节点存储数据。
   - 叶子节点形成有序链表，优化顺序访问性能，常用于数据库索引。
   - 适用于范围查询。
3. **哈希索引：**
   - 使用哈希函数将关键字映射到固定大小的桶。
   - 不存储数据，只存储哈希值和指向实际数据的指针。
   - 适用于等值查询，但不支持范围查询。

### B+ 树

B+树在数据库中作为索引的选择有一些优势，这些优势使得它特别适合作为索引结构：

1. **范围查询和排序效率：** B+树通过有序链表叶子节点，使范围查询和排序操作更为高效，是其最显著的优势。
2. **减少磁盘I/O次数：** B+树结构降低了搜索路径上的非叶子节点数量，减少了磁盘I/O的次数，提高了查询性能。B+树的内部节点相对较小，适合磁盘存储，能够存储更多的关键字，降低了每次磁盘读取的代价。
4. **简化查询逻辑：** B+树的结构简化了查询逻辑，使搜索路径更直接，维护相对稳定（O(log n)）的性能。
